name: dbt on Dremio Software (Dev -> Prod -> Prod2)

on:
  push:
    branches:
      - develop
      - main

defaults:
  run:
    shell: cmd

jobs:
  # ---------- DEV: runs on `develop` ----------
  dev-deploy:
    name: Dev deploy (HTTP)
    runs-on: [self-hosted, Windows]
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Python
        run: |
          python --version
          python -m pip --version

      - name: Upgrade pip & install dbt-core + dbt-dremio
        run: |
          python -m pip install --upgrade pip
          python -m pip install "dbt-core==1.7.*" dbt-dremio
          python -m pip show dbt-core dbt-dremio
          where dbt

      - name: Create profiles.yml (Windows-safe via cmd)
        run: |
          if not exist "%USERPROFILE%\.dbt" mkdir "%USERPROFILE%\.dbt"
          (
            echo dbt_cicd_profile:
            echo   target: dev
            echo   outputs:
            echo     dev:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_DEV_HOST }}"
            echo       port: ${{ secrets.DREMIO_DEV_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_DEV_USER }}"
            echo       password: "${{ secrets.DREMIO_DEV_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_DEV_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_DEV_SPACE_FOLDER }}"
            echo     prod:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_PROD_HOST }}"
            echo       port: ${{ secrets.DREMIO_PROD_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_PROD_USER }}"
            echo       password: "${{ secrets.DREMIO_PROD_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_PROD_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_PROD_SPACE_FOLDER }}"
            echo     prod2:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_PROD2_HOST }}"
            echo       port: ${{ secrets.DREMIO_PROD2_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_PROD2_USER }}"
            echo       password: "${{ secrets.DREMIO_PROD2_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_PROD2_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_PROD2_SPACE_FOLDER }}"
          ) > "%USERPROFILE%\.dbt\profiles.yml"

      - name: Debug profiles.yml
        run: type "%USERPROFILE%\.dbt\profiles.yml"

      - name: Connectivity check to Dremio (HTTP via curl - DEV)
        run: |
          set URL=http://${{ secrets.DREMIO_DEV_HOST }}:${{ secrets.DREMIO_DEV_PORT }}/apiv2/login
          echo Testing: %URL%
          curl -I "%URL%" || exit /b 1

      - name: dbt version
        run: dbt --version

      - name: dbt debug
        run: dbt debug --profiles-dir "%USERPROFILE%\.dbt"

      - name: dbt deps
        run: dbt deps

      - name: dbt build (dev target)
        run: dbt build --profiles-dir "%USERPROFILE%\.dbt" --profile dbt_cicd_profile --target dev

      - name: dbt test (dev)
        run: dbt test --profiles-dir "%USERPROFILE%\.dbt" --profile dbt_cicd_profile --target dev

  # ---------- PROD: runs on `main` ----------
  prod-deploy:
    name: Prod deploy (HTTP)
    runs-on: [self-hosted, Windows]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Python
        run: |
          python --version
          python -m pip --version

      - name: Upgrade pip & install dbt-core + dbt-dremio
        run: |
          python -m pip install --upgrade pip
          python -m pip install "dbt-core==1.7.*" dbt-dremio
          python -m pip show dbt-core dbt-dremio
          where dbt

      - name: Create profiles.yml (Windows-safe via cmd)
        run: |
          if not exist "%USERPROFILE%\.dbt" mkdir "%USERPROFILE%\.dbt"
          (
            echo dbt_cicd_profile:
            echo   target: prod
            echo   outputs:
            echo     dev:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_DEV_HOST }}"
            echo       port: ${{ secrets.DREMIO_DEV_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_DEV_USER }}"
            echo       password: "${{ secrets.DREMIO_DEV_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_DEV_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_DEV_SPACE_FOLDER }}"
            echo     prod:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_PROD_HOST }}"
            echo       port: ${{ secrets.DREMIO_PROD_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_PROD_USER }}"
            echo       password: "${{ secrets.DREMIO_PROD_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_PROD_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_PROD_SPACE_FOLDER }}"
            echo     prod2:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_PROD2_HOST }}"
            echo       port: ${{ secrets.DREMIO_PROD2_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_PROD2_USER }}"
            echo       password: "${{ secrets.DREMIO_PROD2_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_PROD2_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_PROD2_SPACE_FOLDER }}"
          ) > "%USERPROFILE%\.dbt\profiles.yml"

      - name: Debug profiles.yml
        run: type "%USERPROFILE%\.dbt\profiles.yml"

      - name: Connectivity check to Dremio (HTTP via curl - PROD)
        run: |
          set URL=http://${{ secrets.DREMIO_PROD_HOST }}:${{ secrets.DREMIO_PROD_PORT }}/apiv2/login
          echo Testing: %URL%
          curl -I "%URL%" || exit /b 1

      - name: dbt version
        run: dbt --version

      - name: dbt debug
        run: dbt debug --profiles-dir "%USERPROFILE%\.dbt"

      - name: dbt deps
        run: dbt deps

      - name: dbt build (prod target)
        run: dbt build --profiles-dir "%USERPROFILE%\.dbt" --profile dbt_cicd_profile --target prod

      - name: dbt test (prod)
        run: dbt test --profiles-dir "%USERPROFILE%\.dbt" --profile dbt_cicd_profile --target prod

  # ---------- PROD2: runs on `main` AFTER prod ----------
  prod2-deploy:
    name: Prod2 deploy (HTTP)
    runs-on: [self-hosted, Windows]
    if: github.ref == 'refs/heads/main'
    needs: prod-deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Python
        run: |
          python --version
          python -m pip --version

      - name: Upgrade pip & install dbt-core + dbt-dremio
        run: |
          python -m pip install --upgrade pip
          python -m pip install "dbt-core==1.7.*" dbt-dremio
          python -m pip show dbt-core dbt-dremio
          where dbt

      - name: Create profiles.yml (Windows-safe via cmd)
        run: |
          if not exist "%USERPROFILE%\.dbt" mkdir "%USERPROFILE%\.dbt"
          (
            echo dbt_cicd_profile:
            echo   target: prod2
            echo   outputs:
            echo     dev:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_DEV_HOST }}"
            echo       port: ${{ secrets.DREMIO_DEV_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_DEV_USER }}"
            echo       password: "${{ secrets.DREMIO_DEV_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_DEV_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_DEV_SPACE_FOLDER }}"
            echo     prod:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_PROD_HOST }}"
            echo       port: ${{ secrets.DREMIO_PROD_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_PROD_USER }}"
            echo       password: "${{ secrets.DREMIO_PROD_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_PROD_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_PROD_SPACE_FOLDER }}"
            echo     prod2:
            echo       type: dremio
            echo       threads: 2
            echo       environment: software
            echo       software_host: "${{ secrets.DREMIO_PROD2_HOST }}"
            echo       port: ${{ secrets.DREMIO_PROD2_PORT }}
            echo       use_ssl: false
            echo       user: "${{ secrets.DREMIO_PROD2_USER }}"
            echo       password: "${{ secrets.DREMIO_PROD2_PASSWORD }}"
            echo       dremio_space: "${{ secrets.DREMIO_PROD2_SPACE }}"
            echo       dremio_space_folder: "${{ secrets.DREMIO_PROD2_SPACE_FOLDER }}"
          ) > "%USERPROFILE%\.dbt\profiles.yml"

      - name: Debug profiles.yml
        run: type "%USERPROFILE%\.dbt\profiles.yml"

      - name: Connectivity check to Dremio (HTTP via curl - PROD2)
        run: |
          set URL=http://${{ secrets.DREMIO_PROD2_HOST }}:${{ secrets.DREMIO_PROD2_PORT }}/apiv2/login
          echo Testing: %URL%
          curl -I "%URL%" || exit /b 1

      - name: dbt version
        run: dbt --version

      - name: dbt debug
        run: dbt debug --profiles-dir "%USERPROFILE%\.dbt"

      - name: dbt deps
        run: dbt deps

      - name: dbt build (prod2 target)
        run: dbt build --profiles-dir "%USERPROFILE%\.dbt" --profile dbt_cicd_profile --target prod2

      - name: dbt test (prod2)
        run: dbt test --profiles-dir "%USERPROFILE%\.dbt" --profile dbt_cicd_profile --target prod2